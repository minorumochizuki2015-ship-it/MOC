# セッション引継ぎメモ（2025-10-10）

目的
- 次セッションの作業AIが即座に着手できるよう、現状・次にやること・確認事項・注意点・影響範囲を集約します。

現状サマリ
- 進行中のテーマ: CIポリシー/MCP整合性チェック（Windows向けパス・引数検査）導入。
- 承認・運用状態:
  - ORCH/STATE/flags.md: AUTO_DECIDE=off, FREEZE=off（作業継続可能）
  - ORCH/STATE/STANDBY.md: スタンバイ運用方針あり（重大時のみ通知、通常はMD追記）
  - ORCH/STATE/APPROVALS.md: A011まで承認履歴あり（WORK-RULES・EOLロック統一など承認済み）。
- CI（.github/workflows/ci.yml）: 既存ジョブ（format, lint, type-check, test, coverage, EOL, secret scan, SBOM, resource guard）は稼働。Windows向けMCP整合性検査ジョブは未追加。
- ディレクトリ構造の変化: 本セッションでは新規ファイル・変更なし（この引継ぎMDの追加のみ）。

未完了・進行中タスク
- REVIEW-APPROVAL-POLICY（CMD.md / mcp_policy.yaml / CI方針の承認取得）: in_progress
- CI-IMPLEMENTATION-PR（Windows向け mcp_policy/パス・引数検査スクリプト追加＋ci.yml に検査ジョブ追加）: pending

次にやること（具体手順）
1) スクリプト追加（Windows向けMCP整合性検査）
   - 追加先: scripts/ops/check_mcp_config.py
   - 検査対象: .trae/mcp_servers.json, .trae/mcp_servers_min.json, .trae/mcp_servers.yaml
   - 検査内容（最低限）:
     - ルート指定が前方スラッシュの絶対パス（例: /observability, /artifacts）であること
     - バックスラッシュ（\\）の混入禁止（設定値）
     - --root フラグの不使用（起動引数に含めない）
     - ルート数の整合性（JSON/YAML間での差異検知）
     - パス安全性（.. の禁止、ドライブレター表記の禁止）
   - 出力: 違反の詳細リスト（ファイル・キー・値・違反種類）。違反があれば非ゼロ終了コード。

2) CIジョブの追加
   - .github/workflows/ci.yml に新規ジョブ `mcp-consistency-win` を追加。
   - 実行環境: windows-latest（Windows特有の誤設定検知前提）。
   - Pythonバージョンは既存CIの設定に合わせる（ci.ymlの setup-python を参照）。
   - ステップ案:
     - Checkout → Pythonセットアップ → 依存インストール（必要なら） → `python scripts/ops/check_mcp_config.py --strict` 実行
     - 違反時はジョブ失敗。

3) ドキュメント整合
   - .trae/rules/CMD.md, .trae/rules/mcp_policy.yaml のルールとスクリプト実装の整合確認。
   - 必要ならルール文言の微修正（例: パス表記のガイド）。

4) PR作成・承認取得
   - タイトル例: "Add Windows MCP config consistency checks and CI job"
   - 内容: スクリプト追加、ci.yml ジョブ追加、ドキュメント微修正（あれば）。
   - APPROVALS.md への記録: evidence（Windows絶対パス、\\ 区切り）を台帳に追記。

開始前の確認事項（チェックリスト）
- flags: AUTO_DECIDE=off, FREEZE=off（変更不要）
- 対象ファイルの存在:
  - .github/workflows/ci.yml（既存）
  - .trae/mcp_servers.json / .trae/mcp_servers_min.json / .trae/mcp_servers.yaml（既存）
  - scripts/ops/ ディレクトリ（既存）。`check_mcp_config.py` は未作成。
- ポリシーの読み合わせ:
  - .trae/rules/CMD.md, .trae/rules/mcp_policy.yaml のパス・引数ルール。
- 物理ディレクトリの実在確認（Windows環境）:
  - C:\\Users\\User\\Trae\\ORCH-Next\\observability\
  - C:\\Users\\User\\Trae\\ORCH-Next\\artifacts\

注意点（重要）
- 設定値のパス表記は `/` 正規化を前提（config）。一方で APPROVALS.md の evidence は Windows絶対パスで `\\` 区切り必須。混同しないこと。
- `..` やドライブレター表記（例: `C:`）は設定値では禁止。ただし evidence 記録は Windows絶対パスを許容。
- CIは `windows-latest` で検査ジョブを追加する。既存の Linux ジョブへの影響がないように分離実行。
- 変更規模の制約（user_rules.md より）: 1PRあたりの変更行数・変更ファイル数の上限を意識。大きい場合は分割。
- 既存 EOL チェック（scripts/ops/check_eol.py）や SBOM 署名ジョブとの整合を崩さない（失敗時の扱い確認）。

受入基準（Doneの定義）
- `scripts/ops/check_mcp_config.py` が実装され、ローカルで想定違反を検知できる。
- `ci.yml` に `mcp-consistency-win` ジョブが追加され、CIで正常に通る（違反時は落ちる）。
- ルール文書（CMD.md / mcp_policy.yaml）と実装の整合がとれている。
- PRが作成され、APPROVALS.md に evidence が追記されている。

関連ファイル（着手時に必ず確認）
- .github/workflows/ci.yml
- .trae/mcp_servers.json
- .trae/mcp_servers_min.json
- .trae/mcp_servers.yaml
- .trae/rules/CMD.md
- .trae/rules/mcp_policy.yaml
- ORCH/STATE/APPROVALS.md
- ORCH/STATE/STANDBY.md
- ORCH/STATE/flags.md

参考ディレクトリ（抜粋）
- scripts/ops/
  - check_eol.py
  - deploy.ps1
  - scan_secrets.py
- observability/
  - coverage/
  - junit/
  - lint/
  - sbom/
- artifacts/
  - WORK2-ROADMAP/
  - phase4_dashboard/

次セッションでの推奨作業順序
1) スクリプト雛形を追加 → ローカルで違反検知の手動テスト。
2) ci.yml に Windowsジョブ追加 → リポジトリにコミットし、CIを走らせる（PRでも可）。
3) CMD.md / mcp_policy.yaml と差分があれば最小修正 → レビュー。
4) PR作成 → 承認取得 → APPROVALS.md へ evidence 追記。

想定コマンド例（ローカル）
- `python scripts/ops/check_mcp_config.py --strict`
- `pytest -q`
- `black . && isort . && flake8 && mypy`

備考
- スタンバイ運用により通常は会話コンソール投稿を控える方針。必要時のみ報告を行い、基本はMD更新中心で進める。

補足資料
- handoff/quick_start.md（初回着手の流れと注意点の要約）
