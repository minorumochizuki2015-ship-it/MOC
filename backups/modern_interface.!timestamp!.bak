#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
çµ±æ²»æ ¸AI - ãƒ¢ãƒ€ãƒ³UIã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
æœ€æ–°ã®è¦–è¦šçš„UIã‚’ä½¿ç”¨
"""

import json
import threading
import tkinter as tk
import webbrowser
from pathlib import Path
from tkinter import filedialog, messagebox, scrolledtext, ttk
from typing import Any, Dict, Optional

import customtkinter as ctk

from ..core.cursor_ai_system import CursorAISystem


class ModernCursorAIInterface:
    """ãƒ¢ãƒ€ãƒ³ãªCursor AIã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹"""

    def __init__(self, parent=None):
        # CustomTkinterã®è¨­å®š
        ctk.set_appearance_mode("dark")  # ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰
        ctk.set_default_color_theme("blue")  # ãƒ–ãƒ«ãƒ¼ãƒ†ãƒ¼ãƒ

        self.parent = parent or ctk.CTk()
        self.cursor_ai = None
        self.current_file = None
        self.is_processing = False

        self._setup_modern_ui()
        self._initialize_cursor_ai()

    def _setup_modern_ui(self):
        """ãƒ¢ãƒ€ãƒ³UIã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"""
        self.parent.title("çµ±æ²»æ ¸AI - ãƒ¢ãƒ€ãƒ³ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹")
        self.parent.geometry("1600x1000")
        self.parent.minsize(1200, 800)

        # ãƒ¡ã‚¤ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ 
        main_frame = ctk.CTkFrame(self.parent)
        main_frame.pack(fill="both", expand=True, padx=10, pady=10)

        # ãƒ˜ãƒƒãƒ€ãƒ¼
        self._setup_header(main_frame)

        # ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢
        content_frame = ctk.CTkFrame(main_frame)
        content_frame.pack(fill="both", expand=True, pady=(10, 0))

        # å·¦ãƒ‘ãƒãƒ«ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼ï¼‰
        self._setup_file_panel(content_frame)

        # ä¸­å¤®ãƒ‘ãƒãƒ«ï¼ˆã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ï¼‰
        self._setup_editor_panel(content_frame)

        # å³ãƒ‘ãƒãƒ«ï¼ˆAIæ©Ÿèƒ½ï¼‰
        self._setup_ai_panel(content_frame)

        # ä¸‹éƒ¨ãƒ‘ãƒãƒ«ï¼ˆå®Ÿè¡Œçµæœï¼‰
        self._setup_output_panel(main_frame)

    def _setup_header(self, parent):
        """ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"""
        header_frame = ctk.CTkFrame(parent)
        header_frame.pack(fill="x", pady=(0, 10))

        # ã‚¿ã‚¤ãƒˆãƒ«
        title_label = ctk.CTkLabel(
            header_frame,
            text="çµ±æ²»æ ¸AI - ãƒ¢ãƒ€ãƒ³ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹",
            font=ctk.CTkFont(size=24, weight="bold"),
        )
        title_label.pack(side="left", padx=20, pady=10)

        # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        self.status_label = ctk.CTkLabel(
            header_frame, text="åˆæœŸåŒ–ä¸­...", font=ctk.CTkFont(size=12)
        )
        self.status_label.pack(side="right", padx=20, pady=10)

    def _setup_file_panel(self, parent):
        """ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ãƒãƒ«ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"""
        file_frame = ctk.CTkFrame(parent)
        file_frame.pack(side="left", fill="both", expand=False, padx=(0, 5))
        file_frame.configure(width=280)

        # ãƒ‘ãƒãƒ«ã‚¿ã‚¤ãƒˆãƒ«
        title_label = ctk.CTkLabel(
            file_frame,
            text="ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼",
            font=ctk.CTkFont(size=16, weight="bold"),
        )
        title_label.pack(pady=(10, 5))

        # ãƒ•ã‚¡ã‚¤ãƒ«ãƒ„ãƒªãƒ¼
        self.file_tree = ttk.Treeview(file_frame)
        self.file_tree.pack(fill="both", expand=True, padx=10, pady=5)

        # ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œãƒœã‚¿ãƒ³
        button_frame = ctk.CTkFrame(file_frame)
        button_frame.pack(fill="x", padx=10, pady=5)

        ctk.CTkButton(
            button_frame, text="ğŸ“‚ é–‹ã", command=self._open_file, width=60
        ).pack(side="left", padx=2)

        ctk.CTkButton(
            button_frame, text="ğŸ’¾ ä¿å­˜", command=self._save_file, width=60
        ).pack(side="left", padx=2)

        ctk.CTkButton(
            button_frame, text="ğŸ“„ æ–°è¦", command=self._new_file, width=60
        ).pack(side="left", padx=2)

        ctk.CTkButton(
            button_frame, text="ğŸ”„ æ›´æ–°", command=self._refresh_files, width=60
        ).pack(side="left", padx=2)

    def _setup_editor_panel(self, parent):
        """ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ãƒ‘ãƒãƒ«ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"""
        editor_frame = ctk.CTkFrame(parent)
        editor_frame.pack(side="left", fill="both", expand=True, padx=5)

        # ãƒ‘ãƒãƒ«ã‚¿ã‚¤ãƒˆãƒ«
        title_label = ctk.CTkLabel(
            editor_frame, text="âœï¸ ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼", font=ctk.CTkFont(size=16, weight="bold")
        )
        title_label.pack(pady=(10, 5))

        # ã‚¿ãƒ–ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
        self.notebook = ttk.Notebook(editor_frame)
        self.notebook.pack(fill="both", expand=True, padx=10, pady=5)

        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ–
        self._create_new_tab("æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«")

        # ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼æ“ä½œãƒœã‚¿ãƒ³
        button_frame = ctk.CTkFrame(editor_frame)
        button_frame.pack(fill="x", padx=10, pady=5)

        ctk.CTkButton(
            button_frame, text="â–¶ï¸ å®Ÿè¡Œ", command=self._run_code, width=80
        ).pack(side="left", padx=2)

        ctk.CTkButton(
            button_frame, text="ğŸ› ãƒ‡ãƒãƒƒã‚°", command=self._debug_code, width=80
        ).pack(side="left", padx=2)

        ctk.CTkButton(
            button_frame, text="ğŸ¨ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ", command=self._format_code, width=80
        ).pack(side="left", padx=2)

        ctk.CTkButton(
            button_frame, text="ğŸ” åˆ†æ", command=self._analyze_code, width=80
        ).pack(side="left", padx=2)

    def _setup_ai_panel(self, parent):
        """AIãƒ‘ãƒãƒ«ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"""
        ai_frame = ctk.CTkFrame(parent)
        ai_frame.pack(side="right", fill="both", expand=False, padx=(5, 0))
        ai_frame.configure(width=350)

        # ãƒ‘ãƒãƒ«ã‚¿ã‚¤ãƒˆãƒ«
        title_label = ctk.CTkLabel(
            ai_frame, text="ğŸ¤– AIæ”¯æ´", font=ctk.CTkFont(size=16, weight="bold")
        )
        title_label.pack(pady=(10, 5))

        # AIæ©Ÿèƒ½ãƒœã‚¿ãƒ³
        button_frame = ctk.CTkFrame(ai_frame)
        button_frame.pack(fill="x", padx=10, pady=5)

        ctk.CTkButton(
            button_frame,
            text="âœ¨ ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ",
            command=self._generate_code,
            width=150,
            height=35,
        ).pack(fill="x", pady=2)

        ctk.CTkButton(
            button_frame,
            text="ğŸ”§ ã‚³ãƒ¼ãƒ‰è£œå®Œ",
            command=self._complete_code,
            width=150,
            height=35,
        ).pack(fill="x", pady=2)

        ctk.CTkButton(
            button_frame,
            text="ğŸ”„ ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°",
            command=self._refactor_code,
            width=150,
            height=35,
        ).pack(fill="x", pady=2)

        ctk.CTkButton(
            button_frame,
            text="ğŸ¯ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¿ã‚¹ã‚¯",
            command=self._agent_task,
            width=150,
            height=35,
        ).pack(fill="x", pady=2)

        # AIå…¥åŠ›ã‚¨ãƒªã‚¢
        input_frame = ctk.CTkFrame(ai_frame)
        input_frame.pack(fill="both", expand=True, padx=10, pady=5)

        input_label = ctk.CTkLabel(
            input_frame, text="AIå…¥åŠ›", font=ctk.CTkFont(size=14, weight="bold")
        )
        input_label.pack(pady=(10, 5))

        self.ai_input = ctk.CTkTextbox(
            input_frame, height=120, font=ctk.CTkFont(size=12)
        )
        self.ai_input.pack(fill="both", expand=True, padx=10, pady=5)

        # AIå®Ÿè¡Œãƒœã‚¿ãƒ³
        ctk.CTkButton(
            input_frame,
            text="ğŸš€ å®Ÿè¡Œ",
            command=self._execute_ai_request,
            height=40,
            font=ctk.CTkFont(size=14, weight="bold"),
        ).pack(fill="x", padx=10, pady=5)

        # ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹
        status_frame = ctk.CTkFrame(ai_frame)
        status_frame.pack(fill="x", padx=10, pady=5)

        status_label = ctk.CTkLabel(
            status_frame, text="ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹", font=ctk.CTkFont(size=14, weight="bold")
        )
        status_label.pack(pady=(10, 5))

        self.status_text = ctk.CTkTextbox(
            status_frame, height=80, font=ctk.CTkFont(size=10)
        )
        self.status_text.pack(fill="both", expand=True, padx=10, pady=5)

    def _setup_output_panel(self, parent):
        """å‡ºåŠ›ãƒ‘ãƒãƒ«ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"""
        output_frame = ctk.CTkFrame(parent)
        output_frame.pack(fill="x", pady=(10, 0))

        # ãƒ‘ãƒãƒ«ã‚¿ã‚¤ãƒˆãƒ«
        title_label = ctk.CTkLabel(
            output_frame, text="ğŸ“Š å®Ÿè¡Œçµæœ", font=ctk.CTkFont(size=16, weight="bold")
        )
        title_label.pack(pady=(10, 5))

        self.output_text = ctk.CTkTextbox(
            output_frame, height=150, font=ctk.CTkFont(size=12)
        )
        self.output_text.pack(fill="both", expand=True, padx=10, pady=5)

    def _initialize_cursor_ai(self):
        """Cursor AIã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–"""
        try:
            # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§åˆæœŸåŒ–
            import threading

            def init_ai():
                try:
                    self.cursor_ai = CursorAISystem()
                    self.parent.after(
                        0, self._update_status, "âœ… Cursor AIã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†"
                    )
                    self.parent.after(0, self._refresh_files)
                except Exception as e:
                    self.parent.after(0, self._update_status, f"âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: {e}")
                    self.parent.after(
                        0,
                        messagebox.showerror,
                        "ã‚¨ãƒ©ãƒ¼",
                        f"Cursor AIã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}",
                    )

            thread = threading.Thread(target=init_ai)
            thread.daemon = True
            thread.start()

            self._update_status("ğŸ”„ Cursor AIã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...")

        except Exception as e:
            self._update_status(f"âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: {e}")
            messagebox.showerror(
                "ã‚¨ãƒ©ãƒ¼", f"Cursor AIã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}"
            )

    def _create_new_tab(self, title: str, content: str = ""):
        """æ–°ã—ã„ã‚¿ãƒ–ã‚’ä½œæˆ"""
        tab_frame = ctk.CTkFrame(self.notebook)
        self.notebook.add(tab_frame, text=title)

        editor = ctk.CTkTextbox(tab_frame, font=ctk.CTkFont(size=12, family="Consolas"))
        editor.pack(fill="both", expand=True, padx=5, pady=5)
        editor.insert("1.0", content)

        return editor

    def _get_current_editor(self):
        """ç¾åœ¨ã®ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚’å–å¾—"""
        current_tab = self.notebook.select()
        if current_tab:
            tab_index = self.notebook.index(current_tab)
            tab_frame = self.notebook.nametowidget(current_tab)
            for widget in tab_frame.winfo_children():
                if isinstance(widget, ctk.CTkTextbox):
                    return widget
        return None

    def _open_file(self):
        """ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã"""
        file_path = filedialog.askopenfilename(
            title="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã",
            filetypes=[
                ("Python files", "*.py"),
                ("JavaScript files", "*.js"),
                ("TypeScript files", "*.ts"),
                ("HTML files", "*.html"),
                ("CSS files", "*.css"),
                ("JSON files", "*.json"),
                ("Text files", "*.txt"),
                ("All files", "*.*"),
            ],
        )

        if file_path:
            try:
                with open(file_path, "r", encoding="utf-8") as f:
                    content = f.read()

                file_name = Path(file_path).name
                editor = self._create_new_tab(file_name, content)
                self.current_file = file_path
                self._update_status(f"ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã¾ã—ãŸ: {file_name}")

            except Exception as e:
                messagebox.showerror("ã‚¨ãƒ©ãƒ¼", f"ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")

    def _save_file(self):
        """ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜"""
        editor = self._get_current_editor()
        if not editor:
            return

        content = editor.get("1.0", "end-1c")

        if self.current_file:
            file_path = self.current_file
        else:
            file_path = filedialog.asksaveasfilename(
                title="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜",
                defaultextension=".py",
                filetypes=[
                    ("Python files", "*.py"),
                    ("JavaScript files", "*.js"),
                    ("TypeScript files", "*.ts"),
                    ("HTML files", "*.html"),
                    ("CSS files", "*.css"),
                    ("JSON files", "*.json"),
                    ("Text files", "*.txt"),
                    ("All files", "*.*"),
                ],
            )

        if file_path:
            try:
                with open(file_path, "w", encoding="utf-8") as f:
                    f.write(content)

                self.current_file = file_path
                self._update_status(
                    f"ğŸ’¾ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ: {Path(file_path).name}"
                )

            except Exception as e:
                messagebox.showerror("ã‚¨ãƒ©ãƒ¼", f"ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")

    def _new_file(self):
        """æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ"""
        editor = self._create_new_tab("æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«")
        self.current_file = None
        self._update_status("ğŸ“„ æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ")

    def _refresh_files(self):
        """ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’æ›´æ–°"""
        if not self.cursor_ai:
            # ç°¡å˜ãªãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’è¡¨ç¤º
            self._update_simple_file_tree()
            return

        try:
            workspace_info = self.cursor_ai.get_workspace_info()
            self._update_file_tree(workspace_info.get("file_tree", {}))
        except Exception as e:
            self._update_status(f"âŒ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç°¡å˜ãªãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’è¡¨ç¤º
            self._update_simple_file_tree()

    def _update_simple_file_tree(self):
        """ç°¡å˜ãªãƒ•ã‚¡ã‚¤ãƒ«ãƒ„ãƒªãƒ¼ã‚’è¡¨ç¤º"""
        # æ—¢å­˜ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¯ãƒªã‚¢
        for item in self.file_tree.get_children():
            self.file_tree.delete(item)

        # ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡¨ç¤º
        try:
            import os

            for item in os.listdir("."):
                if os.path.isfile(item):
                    icon = "ğŸ" if item.endswith(".py") else "ğŸ“„"
                    self.file_tree.insert("", "end", text=f"{icon} {item}")
        except Exception as e:
            self.file_tree.insert("", "end", text=f"âŒ ã‚¨ãƒ©ãƒ¼: {e}")

    def _update_file_tree(self, file_tree: Dict[str, Any]):
        """ãƒ•ã‚¡ã‚¤ãƒ«ãƒ„ãƒªãƒ¼ã‚’æ›´æ–°"""
        # æ—¢å­˜ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¯ãƒªã‚¢
        for item in self.file_tree.get_children():
            self.file_tree.delete(item)

        # ãƒ•ã‚¡ã‚¤ãƒ«ãƒ„ãƒªãƒ¼ã‚’æ§‹ç¯‰
        self._build_file_tree(file_tree, "")

    def _build_file_tree(self, node: Dict[str, Any], parent_id: str):
        """ãƒ•ã‚¡ã‚¤ãƒ«ãƒ„ãƒªãƒ¼ã‚’å†å¸°çš„ã«æ§‹ç¯‰"""
        if node.get("type") == "directory":
            item_id = self.file_tree.insert(
                parent_id, "end", text=f"ğŸ“ {node['name']}", open=True
            )
            for child in node.get("children", []):
                self._build_file_tree(child, item_id)
        elif node.get("type") == "file":
            icon = "ğŸ" if node["name"].endswith(".py") else "ğŸ“„"
            self.file_tree.insert(parent_id, "end", text=f"{icon} {node['name']}")

    def _run_code(self):
        """ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ"""
        editor = self._get_current_editor()
        if not editor:
            return

        code = editor.get("1.0", "end-1c").strip()
        if not code:
            return

        self._execute_ai_request(
            f"ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:\n```python\n{code}\n```"
        )

    def _debug_code(self):
        """ã‚³ãƒ¼ãƒ‰ã‚’ãƒ‡ãƒãƒƒã‚°"""
        editor = self._get_current_editor()
        if not editor:
            return

        code = editor.get("1.0", "end-1c").strip()
        if not code:
            return

        self._execute_ai_request(
            f"ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ‡ãƒãƒƒã‚°ã—ã¦ãã ã•ã„:\n```python\n{code}\n```"
        )

    def _format_code(self):
        """ã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"""
        editor = self._get_current_editor()
        if not editor:
            return

        code = editor.get("1.0", "end-1c").strip()
        if not code:
            return

        self._execute_ai_request(
            f"ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ã¦ãã ã•ã„:\n```python\n{code}\n```"
        )

    def _analyze_code(self):
        """ã‚³ãƒ¼ãƒ‰ã‚’åˆ†æ"""
        editor = self._get_current_editor()
        if not editor:
            return

        code = editor.get("1.0", "end-1c").strip()
        if not code:
            return

        self._execute_ai_request(
            f"ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’åˆ†æã—ã¦ãã ã•ã„:\n```python\n{code}\n```"
        )

    def _generate_code(self):
        """ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ"""
        description = self.ai_input.get("1.0", "end-1c").strip()
        if not description:
            messagebox.showwarning("è­¦å‘Š", "ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã®èª¬æ˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
            return

        self._execute_ai_request(f"ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„: {description}")

    def _complete_code(self):
        """ã‚³ãƒ¼ãƒ‰ã‚’è£œå®Œ"""
        editor = self._get_current_editor()
        if not editor:
            return

        code = editor.get("1.0", "end-1c").strip()
        if not code:
            return

        self._execute_ai_request(
            f"ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’è£œå®Œã—ã¦ãã ã•ã„:\n```python\n{code}\n```"
        )

    def _refactor_code(self):
        """ã‚³ãƒ¼ãƒ‰ã‚’ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°"""
        editor = self._get_current_editor()
        if not editor:
            return

        code = editor.get("1.0", "end-1c").strip()
        if not code:
            return

        self._execute_ai_request(
            f"ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ã¦ãã ã•ã„:\n```python\n{code}\n```"
        )

    def _agent_task(self):
        """ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œ"""
        description = self.ai_input.get("1.0", "end-1c").strip()
        if not description:
            messagebox.showwarning("è­¦å‘Š", "ã‚¿ã‚¹ã‚¯ã®èª¬æ˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
            return

        self._execute_ai_request(f"ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„: {description}")

    def _execute_ai_request(self, request: str = None):
        """AIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè¡Œ"""
        if not self.cursor_ai:
            messagebox.showerror("ã‚¨ãƒ©ãƒ¼", "Cursor AIã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“")
            return

        if request is None:
            request = self.ai_input.get("1.0", "end-1c").strip()

        if not request:
            return

        if self.is_processing:
            messagebox.showwarning("è­¦å‘Š", "æ—¢ã«å‡¦ç†ä¸­ã§ã™")
            return

        self.is_processing = True
        self._update_status("ğŸ¤– AIå‡¦ç†ä¸­...")

        # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œ
        thread = threading.Thread(target=self._process_ai_request, args=(request,))
        thread.daemon = True
        thread.start()

    def _process_ai_request(self, request: str):
        """AIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰"""
        try:
            # ç›´æ¥kernel.generateã‚’å‘¼ã³å‡ºã—
            from src.core.kernel import generate as _infer

            result_text = _infer(request, max_tokens=128)

            # çµæœã‚’è¾æ›¸å½¢å¼ã§ãƒ©ãƒƒãƒ—
            result = {"success": True, "result": result_text, "summary": "AIå‡¦ç†å®Œäº†"}

            # UIã‚¹ãƒ¬ãƒƒãƒ‰ã§çµæœã‚’è¡¨ç¤º
            self.parent.after(0, self._display_result, result)

        except Exception as e:
            self.parent.after(0, self._display_error, str(e))
        finally:
            self.parent.after(0, self._processing_finished)

    def _display_result(self, result: Dict[str, Any]):
        """çµæœã‚’è¡¨ç¤º"""
        self.output_text.delete("1.0", "end")

        if result.get("success", False):
            self.output_text.insert("end", "=== å®Ÿè¡Œçµæœ ===\n")

            if "result" in result:
                if isinstance(result["result"], dict):
                    self.output_text.insert(
                        "end",
                        json.dumps(result["result"], ensure_ascii=False, indent=2),
                    )
                else:
                    self.output_text.insert("end", str(result["result"]))

            if "summary" in result:
                self.output_text.insert(
                    "end", f"\n\n=== ã‚µãƒãƒªãƒ¼ ===\n{result['summary']}"
                )

            self._update_status("âœ… AIå‡¦ç†å®Œäº†")
        else:
            error = result.get("error", "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼")
            self.output_text.insert("end", f"âŒ ã‚¨ãƒ©ãƒ¼: {error}")
            self._update_status(f"âŒ AIå‡¦ç†ã‚¨ãƒ©ãƒ¼: {error}")

    def _display_error(self, error: str):
        """ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º"""
        self.output_text.delete("1.0", "end")
        self.output_text.insert("end", f"âŒ ã‚¨ãƒ©ãƒ¼: {error}")
        self._update_status(f"âŒ ã‚¨ãƒ©ãƒ¼: {error}")

    def _processing_finished(self):
        """å‡¦ç†å®Œäº†"""
        self.is_processing = False

    def _update_status(self, message: str):
        """ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°"""
        self.status_label.configure(text=message)
        self.status_text.delete("1.0", "end")
        self.status_text.insert("1.0", message)

    def run(self):
        """ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè¡Œ"""
        self.parent.mainloop()


def main():
    """ãƒ¡ã‚¤ãƒ³é–¢æ•°"""
    app = ModernCursorAIInterface()
    app.run()


if __name__ == "__main__":
    main()
