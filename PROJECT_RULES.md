# ORCH-Next プロジェクト絶対ルール

**バージョン**: 1.0  
**最終更新**: 2025-01-06  
**作成者**: AI Assistant  

このドキュメントは、プロジェクトの絶対的なルールを定義します。すべての作業者はこれを厳守し、毎回のセッションで確認してください。パッケージ化・販売可能な状態を目指し、本来のゴールを達成するための基盤です。

## 🔑 基本原則
- **優先順位**: 安全 > 正確 > 再現性 > 速度 > 簡潔
- **変更ポリシー**: 最小差分（unified diff）のみ。全置換禁止。
- **ゲートチェック**: PLAN → TEST → PATCH を厳守。
- **前回の失敗からの学び**: すべての失敗を分析し、再発防止策を記録（`handoff/blocked_items.md` 使用）。

## 📋 絶対ルール一覧

### 1. 毎回の作業ルール確認
- **概要**: セッション開始時に本ルールファイルをレビュー。
- **目的**: 一貫性を保ち、逸脱を防ぐ。
- **実施方法**:
  - セッション開始時に `PROJECT_RULES.md` を読み、遵守を宣言。
  - 違反時は即時修正。
- **適用レベル**: ✅ Always Apply

### 2. ディレクトリの整理
- **概要**: 作業後、無駄なファイルを整理し、パッケージ化に適した構造を維持。
- **目的**: クリーンな状態を保ち、販売可能なパッケージを作成しやすくする。
- **実施方法**:
  - セッション終了時に不要ファイル（一時ファイル、ログの古いもの）を削除。
  - ディレクトリ構造を最適化（例: `src/`、`tests/`、`docs/` の明確化）。
  - ツール使用: `list_dir` で確認、`delete_file` で削除。
- **適用レベル**: ✅ Always Apply
- **注意**: パッケージ化のため、依存関係を `requirements.txt` にまとめ、不要資産を排除。
 - **改行/EOL**: 版管理対象のテキストは LF を厳守（`.gitattributes: * text=auto eol=lf`）。生成物・キャッシュ（`backups/`, `data/`, `ORCH/LOGS/`, `.mypy_cache/`, `.pytest_cache/`, `__pycache__/`）は EOL チェック対象外。
 - **正規化**: 既存 CRLF は `python scripts/ops/normalize_eol.py` で LF に正規化可能。

### 3. マイルストーンの確認とブランチ管理
- **概要**: 毎回マイルストーンを確認、追加作業はブランチ作成、成功時に統合。
- **目的**: 本来のゴールを失わず、段階的に進捗。
- **実施方法**:
  - セッション開始時にマイルストーン（`WORK_TRACKING.md` または `current_priorities.md`）を確認。
  - 追加作業: 新ブランチ作成（例: `feature/new-task`）。
  - 成功時: テスト通過後、メインにマージ（Trunk-based開発準拠）。
  - Gitコマンド使用: `git branch`、`git merge`。
- **適用レベル**: ✅ Always Apply

## 🔄 ブラッシュアップ追加ルール
ユーザーの提案に基づき、以下のルールを追加・強化します。これにより、前回の失敗を活かし、完全リリースまで到達します。

### 4. 失敗分析と再発防止
- **概要**: 失敗発生時に分析し、学びを記録。
- **目的**: 繰り返しの失敗を防ぎ、プロジェクトを確実に進める。
- **実施方法**:
  - 失敗時: 原因分析を `handoff/blocked_items.md` に記録。
  - 再発防止策をルールに統合（例: 追加テスト）。
- **適用レベル**: ✅ Always Apply

### 5. リリースプロセス管理
- **概要**: リリース候補版のビルド・検証を厳格に。
- **目的**: 完全なリリースを保証。
- **実施方法**:
  - マイルストーン達成時: ビルド実行、テストゲート通過。
  - 品質基準: カバレッジ80%以上、脆弱性0件。
  - ツール: `run_command` でビルド、`check_command_status` で検証。
- **適用レベル**: ✅ Always Apply

### 6. セキュリティと品質強化
- **概要**: セキュリティチェックと品質メトリクスを毎回実施。
- **目的**: 販売可能な高品質製品を確保。
- **実施方法**:
  - 変更後: 静的解析（MyPy）、セキュリティスキャン。
  - メトリクス記録: `current_state.json` に更新。
  - 秘密情報管理: README/CI/tests に実値のシークレットを記載しない。例示は `REDACTED`/`CHANGEME`、CI は `jwt-ci`/`webhook-ci` 等の短いプレースホルダーを使用。テストの Bearer は短いプレースホルダーのみ。
  - スキャナ: `python scripts/ops/scan_secrets.py` を実行（除外: `__pycache__/`, `backups/`, `data/logs/`。許容プレースホルダー: `REDACTED`, `CHANGEME`, `jwt-ci`, `webhook-ci`）。
- **適用レベル**: ✅ Always Apply

### 7. ドキュメント管理
- **概要**: すべての変更をドキュメント化。
- **目的**: 引き継ぎとメンテナンスの容易化。
- **実施方法**:
  - 変更時: `WORK_SESSION_TEMPLATE.md` にログ記録。
  - 定期更新: `README.md` と `architecture.md`。
- **適用レベル**: ✅ Always Apply

### 8. テスト強化
- **概要**: テストカバレッジ80%以上を維持、自動テストを必須。
- **目的**: 品質劣化を防ぎ、リリース時のバグを最小化。
- **実施方法**:
  - pre-push hookでpytest実行 (Rule 20)。
  - 統合テストに3秒タイムアウト適用。
  - Canary e2e を `pytest -q -k e2e` で実行、必要に応じて環境変数（`HEALTHCHECK_URL`, `RETRY_SEC`, `MAX_WAIT_SEC`, `SUCCESS_REQUIRED`）で上書き。
- **適用レベル**: ✅ Always Apply

### 9. ドキュメント強化
- **概要**: すべてのコード変更にドキュメント更新を伴う。
- **目的**: メンテナンスと知識共有を容易に。
- **実施方法**:
  - 変更時: APIドキュメントを `docs/api_reference.md` に更新。
  - 定期レビュー: ドキュメントの正確性を確認。
- **適用レベル**: ✅ Always Apply

## 📈 マイルストーン概要
- **Alpha**: 基本機能実装完了
- **Beta**: 品質検証完了
- **RC**: リリース候補版
- **GA**: 一般提供開始

各マイルストーンで全ルール遵守を確認。

## 🔄 更新履歴
- 2025-01-06: 追加ルールブラッシュアップ（セキュリティ、テスト、ドキュメント強化）。ユーザーの提案を統合し、ブラッシュアップ実施。
- 2025-10-07: テスト監査結果に基づき、EOL(LF)強制・除外、秘密情報管理の具体化、Canary e2e の環境変数上書き、秘密情報スキャナ運用、正規化ユーティリティの記載を追加。

**このルールを遵守し、プロジェクトを成功裏にリリースしましょう！**