
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ã‚¿ã‚¤ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - ORION Dashboard</title>
    <link rel="stylesheet" href="/static/css/orion.css">
    <link rel="stylesheet" href="/static/css/dynamic_overrides.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #0a0f1a 0%, #1a2332 50%, #0f1419 100%);
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
            min-height: 100vh;
        }
        .container {
            display: flex;
            height: 100vh;
            background: rgba(26, 35, 50, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            margin: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .sidebar {
            width: 350px;
            background: linear-gradient(180deg, #1a2332 0%, #0f1419 100%);
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #2a3441;
            border-radius: 12px 0 0 12px;
            box-shadow: inset 0 0 20px rgba(0, 234, 255, 0.1);
        }
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-radius: 0 12px 12px 0;
            overflow: hidden;
        }
        .header {
            background: linear-gradient(90deg, #1a2332 0%, #2a3441 100%);
            padding: 15px 20px;
            border-bottom: 1px solid #2a3441;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        .page-selection {
            background: linear-gradient(90deg, #0f1419 0%, #1a2332 100%);
            padding: 15px 20px;
            border-bottom: 1px solid #2a3441;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        .iframe-container {
            flex: 1;
            position: relative;
            background: #ffffff;
        }
        #previewFrame {
            width: 100%;
            height: 100%;
            border: none;
        }
        #selectionOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }
        .element-highlight {
            position: absolute;
            border: 3px solid #00eaff;
            background: rgba(0, 234, 255, 0.1);
            pointer-events: none;
            border-radius: 4px;
            box-shadow: 0 0 20px rgba(0, 234, 255, 0.5);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 20px rgba(0, 234, 255, 0.5); }
            50% { box-shadow: 0 0 30px rgba(0, 234, 255, 0.8); }
            100% { box-shadow: 0 0 20px rgba(0, 234, 255, 0.5); }
        }
        .style-control {
            margin: 12px 0;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .style-control label {
            display: block;
            margin-bottom: 4px;
            color: #ffffff;
            font-weight: 600;
            font-size: 12px;
        }
        .style-control input, .style-control select {
            width: 100%;
            padding: 8px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: #ffffff;
            box-sizing: border-box;
        }
        .btn {
            padding: 12px 18px;
            border: 1px solid #00eaff;
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(0,234,255,0.1) 0%, rgba(0,234,255,0.2) 100%);
            color: #00eaff;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 234, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        .btn:hover {
            background: linear-gradient(135deg, rgba(0,234,255,0.2) 0%, rgba(0,234,255,0.3) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 234, 255, 0.3);
        }
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(0, 234, 255, 0.2);
        }
        .edit-mode-buttons {
            display: flex;
            gap: 8px;
            margin: 16px 0;
        }
        .edit-mode-btn {
            flex: 1;
            padding: 8px 4px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px;
            color: #8aa0c8;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .edit-mode-btn:hover {
            background: rgba(255,255,255,0.1);
            color: #ffffff;
        }
        .edit-mode-btn.active {
            background: rgba(0,234,255,0.2);
            border-color: #00eaff;
            color: #00eaff;
        }
        #selectionOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10000;
        }
        .element-highlight {
            position: fixed;
            border: 2px solid #00eaff;
            background: rgba(0,234,255,0.1);
            pointer-events: none;
            z-index: 10001;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
        <div class="sidebar">
            <h2 style="margin: 0 0 20px 0; color: #00eaff;">ğŸ¨ ã‚¹ã‚¿ã‚¤ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h2>
            
            <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
             <div style="margin-bottom: 20px;">
                 <a href="/dashboard" style="color: #8aa0c8; text-decoration: none; margin-right: 15px; padding: 8px 16px; border-radius: 4px; transition: all 0.2s ease;">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
                 <a href="/tasks" style="color: #8aa0c8; text-decoration: none; margin-right: 15px; padding: 8px 16px; border-radius: 4px; transition: all 0.2s ease;">ã‚¿ã‚¹ã‚¯</a>
                 <a href="/style-manager" style="color: #00eaff; text-decoration: none; background: rgba(0,234,255,0.1); padding: 8px 16px; border-radius: 4px;">ã‚¹ã‚¿ã‚¤ãƒ«ç®¡ç†</a>
             </div>

            <!-- æ¥ç¶šè¨­å®šï¼ˆãƒ™ãƒ¼ã‚¹URLï¼‰ -->
            <div style="margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; color: #ffffff;">ğŸ”Œ æ¥ç¶šè¨­å®š</h3>
                <input id="baseUrlInput" placeholder="http://127.0.0.1:5001" style="width: 100%; padding: 8px; background: #2a3441; color: #ffffff; border: 1px solid #00eaff; border-radius: 6px;">
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                    <button id="saveBaseUrlBtn" class="btn" style="flex: 1; font-size: 11px;">ğŸ’¾ ä¿å­˜</button>
                    <button id="pingBaseUrlBtn" class="btn" style="flex: 1; font-size: 11px;">ğŸ“¡ æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
                </div>
                <div id="baseUrlStatus" style="margin-top: 8px; font-size: 12px; color: #8aa0c8;">æœªè¨­å®šï¼ˆç›¸å¯¾ãƒ‘ã‚¹ã§æ¥ç¶šï¼‰</div>
            </div>

            <!-- ãƒšãƒ¼ã‚¸é¸æŠ -->
            <div style="margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; color: #ffffff;">ğŸ“„ ãƒšãƒ¼ã‚¸é¸æŠ</h3>
                <select id="pageSelect" style="width: 100%; padding: 8px; background: #2a3441; color: #ffffff; border: 1px solid #00eaff; border-radius: 6px; margin-bottom: 10px;">
                    <option value="">ãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿</option>
                </select>
                <button id="loadPageBtn" class="btn" style="width: 100%;">ğŸ“– ãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿</button>
            </div>

            <!-- ãƒ©ã‚¤ãƒ–ç·¨é›†ç”»é¢ -->
            <div style="margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; color: #ffffff;">ğŸ–¥ï¸ ãƒ©ã‚¤ãƒ–ç·¨é›†ç”»é¢</h3>
                <div style="display: flex; gap: 8px;">
                    <button id="compareBtn" class="btn" style="flex: 1; font-size: 11px;">ğŸ“Š æ¯”è¼ƒè¡¨ç¤º</button>
                    <button id="resetViewBtn" class="btn" style="flex: 1; font-size: 11px;">ğŸ”„ ã‚ºãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
                <div id="editModeText" style="margin-top: 8px; padding: 8px; background: rgba(0,234,255,0.1); border-radius: 4px; font-size: 11px; color: #00eaff;">
                    ğŸ¯ é¸æŠãƒ¢ãƒ¼ãƒ‰: è¦ç´ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã—ã¦ãã ã•ã„
                </div>
            </div>

            <!-- ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ç·¨é›†ãƒ„ãƒ¼ãƒ« -->
            <div style="margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; color: #ffffff;">ğŸ¨ ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ç·¨é›†ãƒ„ãƒ¼ãƒ«</h3>
                <div class="edit-mode-buttons">
                    <button id="selectModeBtn" class="edit-mode-btn active" onclick="setEditMode('select')">ğŸ¯ é¸æŠ</button>
                    <button id="colorModeBtn" class="edit-mode-btn" onclick="setEditMode('color')">ğŸ¨ è‰²</button>
                    <button id="textModeBtn" class="edit-mode-btn" onclick="setEditMode('text')">ğŸ“ æ–‡å­—</button>
                    <button id="moveModeBtn" class="edit-mode-btn" onclick="setEditMode('move')">â†”ï¸ ç§»å‹•</button>
                </div>
                <!-- é¸æŠæƒ…å ± -->
                <div id="selectionInfo" style="display:none; font-size:12px; color:#8aa0c8; margin-top:8px;">
                    é¸æŠ: <span id="selTag"></span> <span id="selId"></span> <span id="selClass"></span>
                </div>
                <!-- è‰²ç·¨é›†ãƒ„ãƒ¼ãƒ« -->
                <div id="colorTools" style="display:none; margin-top:10px;">
                    <div class="style-control">
                        <label>é¸æŠè¦ç´ ã®æ–‡å­—è‰²</label>
                        <input type="color" id="selected_text_color" value="#ffffff">
                    </div>
                    <div class="style-control">
                        <label>é¸æŠè¦ç´ ã®èƒŒæ™¯è‰²</label>
                        <input type="color" id="selected_bg_color" value="#0a0f1a">
                    </div>
                    <button id="applySelectedColorsBtn" class="btn" style="width:100%;">ğŸ¨ é©ç”¨</button>
                </div>
                <!-- å¤‰æ›´ãƒ­ã‚° -->
                <div id="changeLog" style="margin-top:12px; font-size:12px; color:#8aa0c8;"></div>
            </div>

            <!-- è©³ç´°è¨­å®š -->
            <details style="margin-top: 16px;">
                <summary style="cursor: pointer; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 6px; margin-bottom: 8px; color: #ffffff;">âš™ï¸ è©³ç´°è¨­å®š</summary>
                
                <div class="style-control">
                    <label>ãƒ†ãƒ¼ãƒ–ãƒ«æ–‡å­—è‰²</label>
                    <input type="color" id="table_text_color" value="#ffffff">
                </div>
                
                <div class="style-control">
                    <label>ãƒ†ãƒ¼ãƒ–ãƒ«èƒŒæ™¯è‰²</label>
                    <input type="color" id="table_bg_color" value="#0a0f1a">
                </div>
                
                <div class="style-control">
                    <label>ãƒœã‚¿ãƒ³æ–‡å­—è‰²</label>
                    <input type="color" id="button_text_color" value="#ffffff">
                </div>
                
                <div class="style-control">
                    <label>ãƒœã‚¿ãƒ³èƒŒæ™¯è‰²</label>
        <input type="color" id="button_bg_color" value="#00eaff" data-sem-role="color-input" data-sem-intent="button_bg_color">
                </div>
            </details>

            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
            <div style="margin-top: 20px; display: flex; gap: 10px;">
        <button id="applyBtn" class="btn" style="flex: 1; background: rgba(0,234,255,0.2);" data-sem-role="apply-button" data-sem-intent="save-styles">âœ… é©ç”¨</button>
                <button id="resetBtn" class="btn" style="flex: 1; background: rgba(255,100,100,0.2); border-color: #ff6464; color: #ff6464;">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="main-content">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="header">
                <h1 style="margin: 0; color: #ffffff;">ã‚¹ã‚¿ã‚¤ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
                <div style="color: #8aa0c8;">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç·¨é›†</div>
            </div>

            <!-- ãƒšãƒ¼ã‚¸é¸æŠã‚¨ãƒªã‚¢ -->
            <div class="page-selection">
                <div style="color: #8aa0c8; font-size: 14px;">
                    å·¦å´ã§ãƒšãƒ¼ã‚¸ã‚’é¸æŠã—ã€èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„
                </div>
            </div>

            <!-- iframeè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="iframe-container" style="display: none;">
                <iframe id="previewFrame" src=""></iframe>
            </div>
        </div>
    </div>

    <!-- é¸æŠã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="selectionOverlay"></div>

    <script>
        let currentStyles = {};
        let originalValues = {};
        let currentEditMode = 'select';
        let selectedElement = null;

        // --- æ¥ç¶šè¨­å®šãƒ˜ãƒ«ãƒ‘ãƒ¼ ---
        function getBaseUrl() {
            return localStorage.getItem('STYLE_BASE_URL') || '';
        }
        function setBaseUrl(url) {
            localStorage.setItem('STYLE_BASE_URL', (url || '').trim());
            updateBaseUrlStatus();
        }
        function api(path) {
            const base = getBaseUrl();
            if (!base) return path;
            return base.replace(/\/$/, '') + path;
        }
        function updateBaseUrlStatus() {
            const base = getBaseUrl();
            const el = document.getElementById('baseUrlStatus');
            if (!el) return;
            el.textContent = base ? `æ¥ç¶šå…ˆ: ${base}` : 'æœªè¨­å®šï¼ˆç›¸å¯¾ãƒ‘ã‚¹ã§æ¥ç¶šï¼‰';
        }
        async function pingBaseUrl() {
            const base = getBaseUrl();
            const el = document.getElementById('baseUrlStatus');
            if (!base) { el.textContent = 'æœªè¨­å®šï¼ˆç›¸å¯¾ãƒ‘ã‚¹ã§æ¥ç¶šï¼‰'; return; }
            try {
                const res = await fetch(api('/api/pages'));
                el.textContent = res.ok ? `åˆ°é”æ€§OK: ${base}` : `åˆ°é”æ€§NG(${res.status}): ${base}`;
            } catch (e) {
                el.textContent = `æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${base}`;
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        window.onload = function() {
            // ãƒ™ãƒ¼ã‚¹URLåˆæœŸå€¤
            const input = document.getElementById('baseUrlInput');
            if (input) { input.value = getBaseUrl(); }
            updateBaseUrlStatus();
            loadCurrentStyles();
            loadAvailablePages();
            setupEventListeners();
        };

        function loadCurrentStyles() {
            fetch(api('/api/styles'))
                .then(response => response.json())
                .then(data => {
                    currentStyles = data;
                    originalValues = {...data};
                    updateInputs(data);
                    console.log('ã‚¹ã‚¿ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                })
                .catch(error => {
                    console.error('ã‚¹ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                });
        }

        function loadAvailablePages() {
            fetch(api('/api/pages'))
                .then(response => response.json())
                .then(pages => {
                    const select = document.getElementById('pageSelect');
                    select.innerHTML = '<option value="">ãƒšãƒ¼ã‚¸ã‚’é¸æŠ...</option>';
                    
                    pages.forEach(page => {
                        const option = document.createElement('option');
                        option.value = page.url;
                        option.textContent = `${page.name} - ${page.description}`;
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('ãƒšãƒ¼ã‚¸ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                });
        }

        function setupEventListeners() {
            document.getElementById('loadPageBtn').addEventListener('click', loadSelectedPage);
            document.getElementById('applyBtn').addEventListener('click', applyStyles);
            document.getElementById('resetBtn').addEventListener('click', resetStyles);
            const saveBtn = document.getElementById('saveBaseUrlBtn');
            const pingBtn = document.getElementById('pingBaseUrlBtn');
            const input = document.getElementById('baseUrlInput');
            if (saveBtn && input) {
                saveBtn.addEventListener('click', () => setBaseUrl(input.value));
            }
            if (pingBtn) {
                pingBtn.addEventListener('click', pingBaseUrl);
            }
            bindSelectedStyleInputs();
        }

        function loadSelectedPage() {
            const select = document.getElementById('pageSelect');
            const selectedUrl = select.value;
            
            if (!selectedUrl) {
                alert('ãƒšãƒ¼ã‚¸ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const iframe = document.getElementById('previewFrame');
            const container = document.querySelector('.iframe-container');
            
            const base = getBaseUrl();
            const full = base ? base.replace(/\/$/, '') + selectedUrl : (window.location.origin + selectedUrl);
            iframe.src = '/preview?target=' + encodeURIComponent(full);
            container.style.display = 'block';
            
            iframe.onload = function() {
                try {
                    setupIframeInteraction();
                    console.log('ãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', selectedUrl);
                } catch (error) {
                    console.error('iframeè¨­å®šã‚¨ãƒ©ãƒ¼:', error);
                }
            };
        }

        function setupIframeInteraction() {
            const iframe = document.getElementById('previewFrame');
            if (!iframe) return;
            
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            if (!iframeDoc) return;
            
            const allElements = iframeDoc.querySelectorAll('*');
            allElements.forEach(element => {
                element.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    selectElement(element);
                });
                
                element.addEventListener('mouseenter', function(e) {
                    if (element.tagName !== 'HTML' && element.tagName !== 'BODY') {
                        element.style.outline = '2px solid #00eaff';
                        element.style.outlineOffset = '2px';
                    }
                });
                
                element.addEventListener('mouseleave', function(e) {
                    element.style.outline = '';
                    element.style.outlineOffset = '';
                });
            });
        }

        function selectElement(element) {
            selectedElement = element;
            console.log('è¦ç´ ã‚’é¸æŠã—ã¾ã—ãŸ:', element.tagName, element.className);
            
            // é¸æŠãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è¡¨ç¤º
            showElementSelection(element);
            // é¸æŠæƒ…å ±æ›´æ–°
            updateSelectionInfoPanel();
            // è‰²ãƒ„ãƒ¼ãƒ«åˆæœŸå€¤åæ˜ 
            showColorTools(element);
        }

        function showElementSelection(element) {
            const iframe = document.getElementById('previewFrame');
            const overlay = document.getElementById('selectionOverlay');
            
            if (!iframe || !overlay) return;
            
            const rect = element.getBoundingClientRect();
            const iframeRect = iframe.getBoundingClientRect();
            
            overlay.innerHTML = '';
            
            const highlight = document.createElement('div');
            highlight.className = 'element-highlight';
            highlight.style.left = (rect.left + iframeRect.left) + 'px';
            highlight.style.top = (rect.top + iframeRect.top) + 'px';
            highlight.style.width = rect.width + 'px';
            highlight.style.height = rect.height + 'px';
            
            overlay.appendChild(highlight);
        }

        function setEditMode(mode) {
            currentEditMode = mode;
            
            document.querySelectorAll('.edit-mode-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(mode + 'ModeBtn').classList.add('active');
            
            const modeTexts = {
                'select': 'ğŸ¯ é¸æŠãƒ¢ãƒ¼ãƒ‰: è¦ç´ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã—ã¦ãã ã•ã„',
                'color': 'ğŸ¨ è‰²ç·¨é›†ãƒ¢ãƒ¼ãƒ‰: è¦ç´ ã‚’é¸æŠã—ã¦è‰²ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„',
                'text': 'ğŸ“ æ–‡å­—ç·¨é›†ãƒ¢ãƒ¼ãƒ‰: ãƒ†ã‚­ã‚¹ãƒˆè¦ç´ ã‚’é¸æŠã—ã¦ãƒ•ã‚©ãƒ³ãƒˆã‚’èª¿æ•´ã—ã¦ãã ã•ã„',
                'move': 'â†”ï¸ ç§»å‹•ãƒ¢ãƒ¼ãƒ‰: è¦ç´ ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä½ç½®ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„'
            };
            document.getElementById('editModeText').textContent = modeTexts[mode];

            // ãƒ„ãƒ¼ãƒ«ã®è¡¨ç¤ºåˆ‡æ›¿
            const colorTools = document.getElementById('colorTools');
            if (colorTools) colorTools.style.display = (mode === 'color') ? 'block' : 'none';
        }

        function updateInputs(styles) {
            Object.keys(styles).forEach(key => {
                const input = document.getElementById(key);
                if (input) {
                    input.value = styles[key];
                }
            });
        }

        function applyStyles() {
            const inputs = document.querySelectorAll('.style-control input');
            const styles = {};
            
            inputs.forEach(input => {
                styles[input.id] = input.value;
            });
            
            fetch(api('/api/styles'), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ styles })
            })
            .then(response => response.json())
            .then(data => {
                console.log('ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨ã—ã¾ã—ãŸ');
                // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦å¤‰æ›´ã‚’åæ˜ 
                const iframe = document.getElementById('previewFrame');
                if (iframe.src) {
                    iframe.src = iframe.src;
                }
            })
            .catch(error => {
                console.error('ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨ã‚¨ãƒ©ãƒ¼:', error);
            });
        }

        function resetStyles() {
            fetch(api('/api/styles/reset'), {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                console.log('ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
                loadCurrentStyles();
                // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦å¤‰æ›´ã‚’åæ˜ 
                const iframe = document.getElementById('previewFrame');
                if (iframe.src) {
                    iframe.src = iframe.src;
                }
            })
            .catch(error => {
                console.error('ã‚¹ã‚¿ã‚¤ãƒ«ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
            });
        }

        // --- é¸æŠæƒ…å ±ï¼†è‰²ç·¨é›† ---
        let modifications = [];

        function updateSelectionInfoPanel() {
            const info = document.getElementById('selectionInfo');
            const tag = document.getElementById('selTag');
            const id = document.getElementById('selId');
            const cls = document.getElementById('selClass');
            if (!selectedElement || !info) return;
            info.style.display = 'block';
            tag.textContent = selectedElement.tagName.toLowerCase();
            id.textContent = selectedElement.id ? ('#' + selectedElement.id) : '';
            cls.textContent = selectedElement.className ? ('.' + selectedElement.className.replace(/\s+/g, '.')) : '';
        }

        function showColorTools(element) {
            const colorTools = document.getElementById('colorTools');
            if (!colorTools || !element) return;
            const cs = (element.ownerDocument.defaultView || window).getComputedStyle(element);
            const textInp = document.getElementById('selected_text_color');
            const bgInp = document.getElementById('selected_bg_color');
            if (textInp) textInp.value = rgbToHex(cs.color);
            if (bgInp) bgInp.value = rgbToHex(cs.backgroundColor);
        }

        function bindSelectedStyleInputs() {
            const btn = document.getElementById('applySelectedColorsBtn');
            if (btn) {
                btn.addEventListener('click', () => {
                    if (!selectedElement) { alert('è¦ç´ ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
                    const textColor = document.getElementById('selected_text_color').value;
                    const bgColor = document.getElementById('selected_bg_color').value;
                    selectedElement.style.color = textColor;
                    selectedElement.style.backgroundColor = bgColor;
                    logModification(selectedElement, { color: textColor, backgroundColor: bgColor });
                });
            }
        }

        function logModification(element, styles) {
            const selector = buildSelector(element);
            modifications.push({ selector, styles, time: new Date().toLocaleTimeString() });
            const log = document.getElementById('changeLog');
            if (log) {
                log.innerHTML = modifications.slice(-10).map(m => `# ${m.time} ${m.selector} â†’ ${JSON.stringify(m.styles)}`).join('<br>');
            }
            console.log('å¤‰æ›´ãƒ­ã‚°:', selector, styles);
        }

        function buildSelector(el) {
            if (!el) return '';
            const tag = el.tagName.toLowerCase();
            const id = el.id ? ('#' + el.id) : '';
            const cls = el.className ? ('.' + el.className.trim().replace(/\s+/g, '.')) : '';
            return tag + id + cls;
        }

        function rgbToHex(rgb) {
            if (!rgb) return '#000000';
            const m = rgb.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
            if (!m) return '#000000';
            const r = parseInt(m[1]).toString(16).padStart(2, '0');
            const g = parseInt(m[2]).toString(16).padStart(2, '0');
            const b = parseInt(m[3]).toString(16).padStart(2, '0');
            return `#${r}${g}${b}`;
        }
    </script>
</body>
</html>

