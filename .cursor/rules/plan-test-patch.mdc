---
description: Plan→Test→Patch for code workflow with K=2–4 options.
globs:
  - "src/core/**"
  - "src/ui/**"
  - "agent_mode.py"
  - "ai_assistant.py"
  - "code_executor.py"
alwaysApply: false
---
フロー: PLAN_JSON → run_tests() → PATCH_DIFF。
PLAN_JSON={files,steps,tests,rollback}。必要時K=2–4案を提案し、テスト根拠で選抜。思考は短く。
run_tests() は {passed, failed, summary} を返す。

【Reversibility Gate】
- PROTECTED以外: 直近に Git チェックポイント必須（例: `git add -A && git commit -m "checkpoint" --no-verify`）。無ければ PLAN のみ。
- PROTECTED: Guard手順必須（バックアップ＋原子的書込＋直後検証）。

【Stop Conditions】
- 同一目的で連続2回テスト失敗、または同一差分の再提案 → 中断しロールバック手順のみ提示。

【Granularity】
- 1回の PATCH_DIFF は**1ファイルのみ**。多ファイル一括は出さない。
