<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>セキュリティダッシュボード - ORCH統合管理システム</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .security-card {
            border-left: 4px solid #007bff;
            transition: all 0.3s ease;
        }
        .security-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-secure { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-danger { background-color: #dc3545; }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
        }
        .audit-log {
            max-height: 400px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }
        .log-entry {
            border-bottom: 1px solid #dee2e6;
            padding: 8px 0;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .timestamp {
            color: #6c757d;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-shield-alt me-2"></i>
                ORCH セキュリティダッシュボード
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-home me-1"></i>
                    メインダッシュボード
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- セキュリティステータス概要 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card security-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-shield-alt me-2"></i>
                            セキュリティステータス概要
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="security-overview">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="metric-value" id="overall-status">-</div>
                                    <div class="text-muted">総合ステータス</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="metric-value" id="active-sessions">-</div>
                                    <div class="text-muted">アクティブセッション</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="metric-value" id="failed-attempts">-</div>
                                    <div class="text-muted">失敗ログイン試行</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="metric-value" id="security-score">-</div>
                                    <div class="text-muted">セキュリティスコア</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- 認証管理 -->
            <div class="col-md-6 mb-4">
                <div class="card security-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-user-lock me-2"></i>
                            認証管理
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- ログインフォーム -->
                        <div class="mb-4">
                            <h6>ユーザーログイン</h6>
                            <form id="login-form">
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="login-username" placeholder="ユーザー名" required>
                                </div>
                                <div class="mb-3">
                                    <input type="password" class="form-control" id="login-password" placeholder="パスワード" required>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-sign-in-alt me-1"></i>
                                    ログイン
                                </button>
                            </form>
                        </div>

                        <!-- ユーザー登録フォーム -->
                        <div class="mb-4">
                            <h6>新規ユーザー登録</h6>
                            <form id="register-form">
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="register-username" placeholder="ユーザー名" required>
                                </div>
                                <div class="mb-3">
                                    <input type="password" class="form-control" id="register-password" placeholder="パスワード" required>
                                </div>
                                <div class="mb-3">
                                    <select class="form-control" id="register-role">
                                        <option value="user">ユーザー</option>
                                        <option value="admin">管理者</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-user-plus me-1"></i>
                                    登録
                                </button>
                            </form>
                        </div>

                        <div id="auth-message" class="alert" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- セキュリティ監査ログ -->
            <div class="col-md-6 mb-4">
                <div class="card security-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-clipboard-list me-2"></i>
                            セキュリティ監査ログ
                        </h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshAuditLogs()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="audit-log" id="audit-logs">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                監査ログを読み込み中...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- セキュリティ設定 -->
        <div class="row">
            <div class="col-12">
                <div class="card security-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>
                            セキュリティ設定
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <h6>認証設定</h6>
                                <ul class="list-unstyled">
                                    <li><span class="status-indicator status-secure"></span>JWT認証有効</li>
                                    <li><span class="status-indicator status-secure"></span>パスワードハッシュ化</li>
                                    <li><span class="status-indicator status-secure"></span>セッション管理</li>
                                </ul>
                            </div>
                            <div class="col-md-4">
                                <h6>暗号化設定</h6>
                                <ul class="list-unstyled">
                                    <li><span class="status-indicator status-secure"></span>データ暗号化</li>
                                    <li><span class="status-indicator status-secure"></span>通信暗号化</li>
                                    <li><span class="status-indicator status-warning"></span>キー管理</li>
                                </ul>
                            </div>
                            <div class="col-md-4">
                                <h6>アクセス制御</h6>
                                <ul class="list-unstyled">
                                    <li><span class="status-indicator status-secure"></span>ロールベース認可</li>
                                    <li><span class="status-indicator status-secure"></span>レート制限</li>
                                    <li><span class="status-indicator status-warning"></span>IP制限</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // セキュリティステータス更新
        function updateSecurityStatus() {
            fetch('/api/security/status')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('セキュリティステータス取得エラー:', data.error);
                        return;
                    }
                    
                    document.getElementById('overall-status').textContent = data.overall_status || 'N/A';
                    document.getElementById('active-sessions').textContent = data.active_sessions || '0';
                    document.getElementById('failed-attempts').textContent = data.failed_login_attempts || '0';
                    document.getElementById('security-score').textContent = data.security_score || 'N/A';
                })
                .catch(error => {
                    console.error('セキュリティステータス更新エラー:', error);
                });
        }

        // 監査ログ更新
        function refreshAuditLogs() {
            fetch('/api/security/audit')
                .then(response => response.json())
                .then(data => {
                    const logsContainer = document.getElementById('audit-logs');
                    
                    if (data.error) {
                        logsContainer.innerHTML = `<div class="text-danger">エラー: ${data.error}</div>`;
                        return;
                    }
                    
                    if (!data.logs || data.logs.length === 0) {
                        logsContainer.innerHTML = '<div class="text-muted">監査ログがありません</div>';
                        return;
                    }
                    
                    const logsHtml = data.logs.map(log => `
                        <div class="log-entry">
                            <div class="d-flex justify-content-between">
                                <span><strong>${log.action}</strong> - ${log.user || 'システム'}</span>
                                <span class="timestamp">${new Date(log.timestamp).toLocaleString()}</span>
                            </div>
                            <div class="text-muted small">${log.details || ''}</div>
                        </div>
                    `).join('');
                    
                    logsContainer.innerHTML = logsHtml;
                })
                .catch(error => {
                    console.error('監査ログ更新エラー:', error);
                    document.getElementById('audit-logs').innerHTML = '<div class="text-danger">監査ログの取得に失敗しました</div>';
                });
        }

        // ログインフォーム処理
        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            fetch('/api/security/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, password })
            })
            .then(response => response.json())
            .then(data => {
                const messageDiv = document.getElementById('auth-message');
                
                if (data.success) {
                    messageDiv.className = 'alert alert-success';
                    messageDiv.textContent = 'ログインに成功しました';
                    messageDiv.style.display = 'block';
                    
                    // トークンを保存（実際のアプリケーションではより安全な方法を使用）
                    localStorage.setItem('auth_token', data.token);
                    
                    // フォームをリセット
                    document.getElementById('login-form').reset();
                } else {
                    messageDiv.className = 'alert alert-danger';
                    messageDiv.textContent = data.error || 'ログインに失敗しました';
                    messageDiv.style.display = 'block';
                }
                
                // ステータスを更新
                updateSecurityStatus();
                refreshAuditLogs();
            })
            .catch(error => {
                console.error('ログインエラー:', error);
                const messageDiv = document.getElementById('auth-message');
                messageDiv.className = 'alert alert-danger';
                messageDiv.textContent = 'ログイン処理中にエラーが発生しました';
                messageDiv.style.display = 'block';
            });
        });

        // 登録フォーム処理
        document.getElementById('register-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const role = document.getElementById('register-role').value;
            
            fetch('/api/security/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, password, role })
            })
            .then(response => response.json())
            .then(data => {
                const messageDiv = document.getElementById('auth-message');
                
                if (data.success) {
                    messageDiv.className = 'alert alert-success';
                    messageDiv.textContent = data.message || 'ユーザー登録に成功しました';
                    messageDiv.style.display = 'block';
                    
                    // フォームをリセット
                    document.getElementById('register-form').reset();
                } else {
                    messageDiv.className = 'alert alert-danger';
                    messageDiv.textContent = data.error || 'ユーザー登録に失敗しました';
                    messageDiv.style.display = 'block';
                }
                
                // ステータスを更新
                updateSecurityStatus();
                refreshAuditLogs();
            })
            .catch(error => {
                console.error('登録エラー:', error);
                const messageDiv = document.getElementById('auth-message');
                messageDiv.className = 'alert alert-danger';
                messageDiv.textContent = '登録処理中にエラーが発生しました';
                messageDiv.style.display = 'block';
            });
        });

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            updateSecurityStatus();
            refreshAuditLogs();
            
            // 定期更新（30秒間隔）
            setInterval(() => {
                updateSecurityStatus();
                refreshAuditLogs();
            }, 30000);
        });
    </script>
</body>
</html>