# 統治核AI開発 - 失敗パターン分析と作業ルール更新

## 成功した修正パターン

### 1. サーバー接続問題の解決

**問題**: 過度なサーバー接続確認によるUI重さ
**解決策**:

- 接続確認間隔を30秒→60秒に削減
- デバッグ出力を削除
- レイアウト処理を初回のみ実行

### 2. UI安定化の実装

**問題**: レイアウト揺れ（同一ボタン100連打でレイアウト変動≦2px）
**解決策**:

- テキスト切り詰め機能（80文字制限）
- バッジ文言固定化（色のみ変更）
- ボタン幅統一機能

### 3. 文字化け問題の解決

**問題**: AI応答での文字化け（mojibake）
**解決策**:

- Unicode正規化（NFC）
- 制御文字除去
- マルチエンコーディング対応

## 失敗パターンと対策

### 1. 未承認修正によるシステム破壊

**失敗例**: ユーザーが明示的に要求していない修正を実施
**対策**:

- 明示的に要求された修正のみ実施
- 修正前に関連する影響範囲を確認
- 小さな変更を段階的に実施

### 2. 過度な機能追加による複雑化

**失敗例**: 一度に多くの機能を追加
**対策**:

- 1つの問題に1つの修正
- 機能追加前に既存機能の安定性を確認
- 段階的な実装アプローチ

### 3. テスト不足による回帰

**失敗例**: 修正後の実地テストを実施せず
**対策**:

- 修正後は必ず実地テストを実施
- Gitコミット前に動作確認
- 段階的な検証プロセス

### 4. デバッグ出力の不完全削除

**失敗例**: 一部のデバッグ出力が残存し、ログが汚染
**対策**:

- デバッグ出力削除時は全体を確認
- grep検索で残存をチェック
- 実地テストで出力を確認
- インデントエラーに注意（except文の後は必ずpassを追加）

### 5. インデントエラーの発生

**失敗例**: デバッグ出力削除時にexcept文の後が空になり、インデントエラーが発生
**対策**:

- except文の後は必ずpassを追加
- 複数箇所の修正時は全体を確認
- フォーマットエラーも同時に修正

## 更新された作業ルール

### 基本原則

1. **明示的承認**: ユーザーが明示的に要求した修正のみ実施
2. **段階的実装**: 小さな変更を段階的に実施
3. **実地テスト**: 修正後は必ず実地テストを実施
4. **Git管理**: 各修正をGitで管理し、問題時は即座にロールバック

### 修正プロセス

1. **問題特定**: 具体的な問題を特定
2. **影響範囲確認**: 修正による影響範囲を確認
3. **最小修正**: 必要最小限の修正を実施
4. **実地テスト**: 修正後の動作を確認
5. **Git保存**: 成功時のみGitに保存

### 品質管理

1. **コード品質**: mypy strict、black、isortを通過
2. **UI安定性**: レイアウト変動≦2px
3. **パフォーマンス**: 過度な処理を避ける
4. **エラーハンドリング**: 適切な例外処理

## 恒久化された対策

### 1. UI安定化機能

- テキスト切り詰め（`_truncate`）
- ボタン幅統一（`_fix_uniform_button_widths`）
- レイアウト固定化（`_layout_fixed`）

### 2. パフォーマンス最適化

- サーバー接続確認頻度削減
- レイアウト処理の初回のみ実行
- デバッグ出力の削減

### 3. 文字化け対策

- Unicode正規化
- 制御文字除去
- マルチエンコーディング対応

## 今後の開発指針

1. **保守性重視**: 複雑な機能追加より既存機能の安定化
2. **段階的改善**: 小さな改善を継続的に実施
3. **実地検証**: 理論だけでなく実地での動作確認
4. **ユーザー中心**: ユーザーの明示的な要求を最優先

## 成功指標

- [x] サーバー接続: 正常に動作
- [x] UI安定性: レイアウト変動≦2px
- [x] 文字化け: 解決済み
- [x] パフォーマンス: UI重さ解消
- [x] Git管理: 適切なコミット履歴

## 注意事項

1. **未承認修正の禁止**: ユーザーが明示的に要求していない修正は実施しない
2. **段階的実装**: 一度に多くの変更を実施しない
3. **実地テスト必須**: 修正後は必ず実地テストを実施
4. **ロールバック準備**: 問題時は即座にロールバック可能な状態を維持
