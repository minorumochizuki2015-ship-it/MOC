# Critical Incident Report - 20251006

## インシデント概要
- 発生日時: 2025-10-06
- 分類: ファイル更新失敗（複数回）
- 対象: docs/ORCH-Next_UI_Fix_Milestones.md
- 影響: 監査指摘への対応が未完了

## 問題の詳細
### 症状
- apply_patch / update_file / edit_file_fast_apply ツールでの更新が反映されない
- ファイルは60行で存在するが、追記された計測結果・品質ゲート確認ブロックが52行時点で止まっている
- 複数回の更新試行にも関わらず変更が永続化されない

### 根本原因分析
1. **ファイルパス不一致**: 
   - 作業ディレクトリ: C:\Users\User\Trae\MOC
   - 対象ファイル: docs/ORCH-Next_UI_Fix_Milestones.md
   - 絶対パス: C:\Users\User\Trae\MOC\docs\ORCH-Next_UI_Fix_Milestones.md

2. **ツール実行結果の検証不足**:
   - apply_patch が "M docs/ORCH-Next_UI_Fix_Milestones.md +12 -0" を返すも実際は未反映
   - ファイル更新後の内容確認を怠った

3. **原子的書込プロセスの不備**:
   - *.tmp → 検証 → *.bak → rename の手順が不完全
   - 書込み権限やファイルロックの可能性

## 対策
### 即座の対応
1. 直接的なファイル更新（write_to_file rewrite=true）
2. 更新後の内容検証
3. SHA256ハッシュによる整合性確認

### 恒久対策
1. **更新後検証の必須化**: 
   - ファイル更新ツール実行後は必ず view_files で内容確認
   - 期待する変更が反映されているかの検証

2. **原子的書込の強化**:
   - 一時ファイル作成 → 内容検証 → バックアップ → 本体更新の手順明確化
   - 各段階での失敗時ロールバック手順

3. **権限・ロック確認**:
   - ファイル書込み権限の事前確認
   - 他プロセスによるファイルロックの検出

## 教訓
- ツールの戻り値だけでなく、実際のファイル内容での検証が必須
- 複数回失敗時は手法を変更し、根本原因を特定する
- クリティカルな更新は段階的検証を徹底する

## 次回予防策
- ファイル更新前後でのSHA256比較
- 更新失敗時の自動ロールバック機構
- 権限・ロック状態の事前診断

## 配置修正履歴
- 2025-10-06: 監査指摘により C:\Users\User\Trae\MOC\docs\ から ORCH/docs/ へ移動